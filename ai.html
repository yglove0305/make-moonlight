<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ™ ë‹¬ë¹› AI ì±—ë´‡ (ì¸ë©”ëª¨ë¦¬)</title>
    <!-- Inter í°íŠ¸ ë¡œë“œ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì§€ì • ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate-900 */
            color: #E2E8F0; /* Slate-200 */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ì±—ë´‡ ì»¨í…Œì´ë„ˆ ë°°ê²½ ë° ê·¸ë¦¼ì */
        .chat-container {
            background-color: #1E293B; /* Slate-800 */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 50px rgba(6, 182, 212, 0.15); /* Cyan glow shadow */
        }

        /* AI ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .ai-message {
            background-color: #0F172A; /* Slate-900 */
            border-left: 4px solid #6366F1; /* Indigo-500 accent */
        }
        
        /* ì‚¬ìš©ì ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .user-message {
            background-color: #334155; /* Slate-700 */
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (ì›¹í‚· ê¸°ë°˜ ë¸Œë¼ìš°ì €) */
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-track {
            background: #1E293B;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .chat-history::-webkit-scrollbar-thumb:hover {
            background: #64748B;
        }

        /* í™•ì¸ ëª¨ë‹¬ ë°°ê²½ ì˜¤ë²„ë ˆì´ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body>

    <!-- ì¤‘ì•™ ì»¨í…Œì´ë„ˆ: ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤ ì „ì²´ -->
    <div class="chat-container w-full max-w-lg mx-auto rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[90vh] sm:h-[80vh] my-4">

        <!-- ì±—ë´‡ í—¤ë” -->
        <header class="p-4 bg-slate-900 border-b border-indigo-700/50 flex items-center justify-between relative">
            
            <button id="clear-chat-button" title="ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì— ìˆëŠ” ëª¨ë“  ì±„íŒ… ê¸°ë¡ ì‚­ì œ"
                    class="p-2 bg-red-700 hover:bg-red-600 text-white text-sm font-medium rounded-xl transition duration-300 shadow-md">
                ê¸°ë¡ ì‚­ì œ
            </button>

            <h1 class="text-xl font-bold text-white flex items-center absolute left-1/2 transform -translate-x-1/2">
                <span class="text-indigo-400 mr-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </span>
                ë‹¬ë¹› AI ì±—ë´‡
            </h1>
            
            <!-- Firebase ì œê±°ë¡œ ì¸í•´ ì‚¬ìš©ì IDëŠ” ì œê±°ë¨ -->
            <div class="text-xs text-slate-500 max-w-[100px] select-none">ì¸ë©”ëª¨ë¦¬ ëª¨ë“œ</div>
        </header>

        <!-- ë©”ì‹œì§€ ê¸°ë¡ ì˜ì—­ -->
        <div id="chat-history" class="chat-history flex-grow p-4 space-y-6 overflow-y-auto">
            <!-- ë©”ì‹œì§€ëŠ” ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
        <div id="loading-indicator" class="hidden p-4 flex justify-start items-center space-x-3 bg-slate-700/50">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-400"></div>
            <span class="text-sm text-indigo-400">ë‹¬ë¹› AIê°€ ìƒê° ì¤‘...</span>
        </div>

        <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
        <footer class="p-4 bg-slate-900 border-t border-cyan-700/50">
            <form id="chat-form" class="flex space-x-3">
                <input type="text" id="user-input" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                       class="flex-grow p-3 rounded-xl bg-slate-800 border border-slate-700 focus:border-indigo-500 focus:ring focus:ring-indigo-500/50 text-white placeholder-slate-500 transition duration-300 outline-none"
                       autocomplete="off" required>
                
                <button type="submit" id="send-button"
                        class="px-5 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl transition duration-300 shadow-lg shadow-indigo-500/30 disabled:bg-slate-600 disabled:shadow-none"
                        disabled>
                    ì „ì†¡
                </button>
            </form>
        </footer>
        
    </div>

    <!-- ì‚¬ìš©ì ë©”ì‹œì§€ ë°•ìŠ¤ (Alert ëŒ€ì²´) -->
    <div id="message-box" class="hidden fixed bottom-5 right-5 z-[9999] p-4 bg-red-600 rounded-lg shadow-2xl items-center space-x-3 transition-all duration-300 transform">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <p id="message-text" class="text-white font-semibold"></p>
    </div>

    <!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ (Confirm ëŒ€ì²´) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[99999] flex items-center justify-center modal-overlay">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-indigo-700">
            <h3 class="text-lg font-bold text-white mb-4">í™•ì¸ í•„ìš”</h3>
            <p id="modal-text" class="text-slate-300 mb-6">ì •ë§ë¡œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition duration-200">
                    ì·¨ì†Œ
                </button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition duration-200">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // =======================================================================
        // 1. ì„¤ì • ë° DOM ìš”ì†Œ ì •ì˜
        // (Firebase ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.)
        // =======================================================================
        const DALBIT_API_KEY = typeof __api_key !== 'undefined' ? __api_key : ""; 
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `${API_BASE_URL}${MODEL_NAME}:generateContent?key=${DALBIT_API_KEY}`;
        
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const clearChatButton = document.getElementById('clear-chat-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // ì¸ë©”ëª¨ë¦¬ ëŒ€í™” ê¸°ë¡ ë°°ì—´
        let conversationHistory = []; 

        // =======================================================================
        // 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =======================================================================

        /**
         * ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (Alert ëŒ€ì²´)
         */
        function showMessage(message, type = 'error') {
            
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');

            // í…Œë§ˆ ì„¤ì •
            messageBox.classList.remove('bg-red-600', 'bg-green-600');
            messageBox.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.classList.remove('flex');
            }, 5000);
        }
        
        /**
         * ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  ì‚¬ìš©ìì˜ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜ (Confirm ëŒ€ì²´)
         */
        function showConfirmModal(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('modal-text').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm-button');
                const cancelBtn = document.getElementById('modal-cancel-button');

                modal.classList.remove('hidden');
                
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }


        /**
         * ì±„íŒ… ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         * @param {string} text ë©”ì‹œì§€ ë‚´ìš©
         * @param {string} role 'user' ë˜ëŠ” 'model'
         * @param {boolean} isWelcome í™˜ì˜ ë©”ì‹œì§€ ì—¬ë¶€
         */
        function appendMessage(text, role, isWelcome = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            
            if (role === 'user') {
                messageBubble.className = 'user-message max-w-xs md:max-w-md p-3 rounded-xl shadow-md text-white';
                messageBubble.textContent = text;
            } else {
                messageBubble.className = isWelcome 
                    ? 'ai-message max-w-xs md:max-w-md p-4 rounded-xl shadow-lg transition duration-300 border-indigo-500' 
                    : 'ai-message max-w-xs md:max-w-md p-4 rounded-xl shadow-lg transition duration-300';
                
                const sender = document.createElement('p');
                sender.className = 'font-semibold text-indigo-300 mb-1';
                sender.textContent = 'ë‹¬ë¹› AI';
                messageBubble.appendChild(sender);

                const content = document.createElement('p');
                content.className = 'text-gray-200 whitespace-pre-wrap';
                // ê°„ë‹¨í•œ Markdown (ë³¼ë“œ, ì´íƒ¤ë¦­, ì¤„ë°”ê¿ˆ)ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ innerHTML ì‚¬ìš©
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // **ë³¼ë“œ**
                formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>'); // *ì´íƒ¤ë¦­*
                content.innerHTML = formattedText;
                messageBubble.appendChild(content);
            }

            chatHistory.appendChild(messageWrapper);
            messageWrapper.appendChild(messageBubble);

            // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ ì´ë™
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€í•˜ê³  ë©”ëª¨ë¦¬ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
         */
        function initializeChat() {
            chatHistory.innerHTML = '';
            conversationHistory = [];
            
            appendMessage(
                "ì•ˆë…•! ë‚˜ëŠ” ë‹¬ë¹› AIì•¼. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë´. ë³µì¡í•œ ì•„ì´ë””ì–´ë¶€í„° ê°„ë‹¨í•œ ì§ˆë¬¸ê¹Œì§€ ë„ì™€ì¤„ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì–´. **(ì´ ê¸°ë¡ì€ ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥ë¼)**", 
                'model', 
                true
            );
        }
        
        /**
         * ì…ë ¥ í•„ë“œì˜ ìƒíƒœì— ë”°ë¼ ì „ì†¡ ë²„íŠ¼ì„ í™œì„±í™”/ë¹„í™œì„±í™”
         */
        function toggleButtonState() {
            sendButton.disabled = userInput.value.trim() === '';
        }

        /**
         * ëŒ€í™” ê¸°ë¡ ì „ì²´ë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
         */
        async function clearHistory() {
            
            const isConfirmed = await showConfirmModal("ì •ë§ë¡œ ë©”ëª¨ë¦¬ì˜ ëª¨ë“  ëŒ€í™” ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)");
            if (!isConfirmed) return;

            initializeChat();
            showMessage('ëª¨ë“  ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆì–´.', 'success');
        }


        // =======================================================================
        // 3. Gemini API í†µì‹  ë¡œì§ (Exponential Backoff í¬í•¨)
        // =======================================================================

        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ (ì§€ìˆ˜ ë°±ì˜¤í”„ í¬í•¨)
         */
        async function fetchGeminiResponse(maxRetries = 5, delay = 1000) {
            if (conversationHistory.length === 0) {
                 throw new Error("API í˜¸ì¶œ ì‹œ conversationHistoryê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            const payload = {
                contents: conversationHistory,
                // ì‹œìŠ¤í…œ ì§€ì¹¨: ë°˜ë§, ì¥ë¬¸ ë‹µë³€
                systemInstruction: {
                    parts: [{ text: "ë„ˆëŠ” í•œêµ­ì–´ì— ëŠ¥í†µí•˜ë©°, ê³ ê¸‰ ë°ì´í„° ë¶„ì„ ë° ì°½ì˜ì  ì½˜í…ì¸  ìƒì„±ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” 'ë‹¬ë¹› AI' ì±—ë´‡ì´ì•¼. ì‚¬ìš©ìì™€ ì¹œêµ¬ì²˜ëŸ¼ í¸í•˜ê³  ê²©ì˜ ì—†ëŠ” ë§íˆ¬(ë°˜ë§)ë¥¼ ì‚¬ìš©í•˜ë©°, ì§ˆë¬¸ì— ëŒ€í•´ í•­ìƒ ë§¤ìš° ìƒì„¸í•˜ê³  ê´‘ë²”ìœ„í•˜ê²Œ ì •ë³´ë¥¼ ì œê³µí•˜ì—¬ ë‹µë³€ì´ ê¸¸ê³  ê¹Šì´ ìˆê²Œ ëŠê»´ì§€ë„ë¡ ì‘ì„±í•´ ì¤˜." }]
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Rate limit exceeded. Retrying...');
                        } else if (response.status >= 400 && response.status < 500) {
                            const errorData = await response.json();
                            throw new Error(`Client Error: ${response.status} - ${errorData.error.message || 'Unknown client error'}`);
                        } else {
                            throw new Error(`Server Error: ${response.status} - Retrying...`);
                        }
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else if (candidate && candidate.finishReason === 'SAFETY') {
                        return "ë¯¸ì•ˆí•´. ìš”ì²­í•œ ë‚´ìš©ì€ ì•ˆì „ ì •ì±… ë•Œë¬¸ì— ìƒì„±í•  ìˆ˜ ì—†ì–´.";
                    } else {
                        throw new Error('API ì‘ë‹µì—ì„œ ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                } catch (error) {
                    // ì„œë²„ ì˜¤ë¥˜ë‚˜ ì†ë„ ì œí•œì¸ ê²½ìš°ì—ë§Œ ì¬ì‹œë„
                    if (i < maxRetries - 1 && (error.message.includes('Rate limit') || error.message.includes('Server Error'))) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. API ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        // =======================================================================
        // 4. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ë©”ì¸ ë¡œì§
        // =======================================================================

        /**
         * ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬ í•¨ìˆ˜
         */
        async function handleSendMessage(e) {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // 1. UI ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            userInput.value = '';
            toggleButtonState();
            sendButton.disabled = true; 
            loadingIndicator.classList.remove('hidden');

            // 2. ì‚¬ìš©ì ë©”ì‹œì§€ ê¸°ë¡ ë° UI ì¶”ê°€
            const userMessage = { role: 'user', parts: [{ text: prompt }] };
            conversationHistory.push(userMessage);
            appendMessage(prompt, 'user');
            
            try {
                // 3. API í˜¸ì¶œ
                const aiResponseText = await fetchGeminiResponse();
                
                // 4. AI ë©”ì‹œì§€ ê¸°ë¡ ë° UI ì¶”ê°€
                const aiMessage = { role: 'model', parts: [{ text: aiResponseText }] };
                conversationHistory.push(aiMessage);
                appendMessage(aiResponseText, 'model');
                
            } catch (error) {
                // 5. ì˜¤ë¥˜ ì²˜ë¦¬
                console.error("ìµœì¢… API ì˜¤ë¥˜:", error);
                const errorMessage = `API í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´: ${error.message}. ëŒ€í™” ê¸°ë¡ì—ì„œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì œê±°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ë´.`;
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ê¸°ë¡ì—ì„œ ì œê±° (ì¬ì‹œë„ ì‹œ ë¬¸ì œê°€ ëœ ë©”ì‹œì§€ ì œì™¸)
                conversationHistory.pop(); 
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œ
                appendMessage(errorMessage, 'model');
                showMessage(errorMessage, 'error');
            } finally {
                // 6. ìƒíƒœ ë³µêµ¬
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
                toggleButtonState();
            }
        }

        // =======================================================================
        // 5. ì´ˆê¸°í™”
        // =======================================================================

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        chatForm.addEventListener('submit', handleSendMessage);
        userInput.addEventListener('input', toggleButtonState);
        clearChatButton.addEventListener('click', clearHistory);

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì±„íŒ… ì´ˆê¸°í™” ë° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        window.onload = () => {
             initializeChat();
             toggleButtonState();
        };

    </script>

</body>
</html>
