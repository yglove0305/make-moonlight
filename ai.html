<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ™ ë‹¬ë¹› AI Pro ì±—ë´‡</title>
    <!-- Inter í°íŠ¸ ë¡œë“œ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì§€ì • ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate-900 */
            color: #E2E8F0; /* Slate-200 */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ì±—ë´‡ ì»¨í…Œì´ë„ˆ ë°°ê²½ ë° ê·¸ë¦¼ì */
        .chat-container {
            background-color: #1E293B; /* Slate-800 */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 50px rgba(6, 182, 212, 0.15); /* Cyan glow shadow */
        }

        /* AI ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .ai-message {
            background-color: #0F172A; /* Slate-900 */
            border-left: 4px solid #6366F1; /* Indigo-500 accent */
        }
        
        /* ì‚¬ìš©ì ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .user-message {
            background-color: #334155; /* Slate-700 */
        }

        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (ì›¹í‚· ê¸°ë°˜ ë¸Œë¼ìš°ì €) */
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-track {
            background: #1E293B;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .chat-history::-webkit-scrollbar-thumb:hover {
            background: #64748B;
        }

        /* í™•ì¸ ëª¨ë‹¬ ë°°ê²½ ì˜¤ë²„ë ˆì´ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>
</head>
<body>

    <!-- ì¤‘ì•™ ì»¨í…Œì´ë„ˆ: ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤ ì „ì²´ -->
    <div class="chat-container w-full max-w-lg mx-auto rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[90vh] sm:h-[80vh] my-4">

        <!-- ì±—ë´‡ í—¤ë” -->
        <header class="p-4 bg-slate-900 border-b border-indigo-700/50 flex items-center justify-between relative">
            <!-- ì‚¬ìš©ì ID í‘œì‹œ (ë””ë²„ê¹…/ê³µìœ ìš©) -->
            <!-- 'ìƒˆ ì±„íŒ…' ë²„íŠ¼ì„ 'ì „ì²´ ì‚­ì œ'ë¡œ ë³€ê²½í•˜ê³  ìƒ‰ìƒì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½ -->
            <button id="new-chat-button" title="ëª¨ë“  ì±„íŒ… ê¸°ë¡ ì‚­ì œ"
                    class="p-2 bg-red-700 hover:bg-red-600 text-white text-sm font-medium rounded-xl transition duration-300 shadow-md">
                ì „ì²´ ì‚­ì œ
            </button>

            <h1 class="text-xl font-bold text-white flex items-center absolute left-1/2 transform -translate-x-1/2">
                <span class="text-indigo-400 mr-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </span>
                ë‹¬ë¹› AI ì±—ë´‡
            </h1>
            
            <div id="user-id-display" class="text-xs text-slate-500 truncate max-w-[100px]" title="ì‚¬ìš©ì ID">ID: ...</div>
        </header>

        <!-- ë©”ì‹œì§€ ê¸°ë¡ ì˜ì—­ -->
        <div id="chat-history" class="chat-history flex-grow p-4 space-y-6 overflow-y-auto">
            <!-- ë©”ì‹œì§€ëŠ” ì—¬ê¸°ì— Firestore onSnapshotì„ í†µí•´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
        <div id="loading-indicator" class="hidden p-4 flex justify-start items-center space-x-3 bg-slate-700/50">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-400"></div>
            <span class="text-sm text-indigo-400">ë‹¬ë¹› AIê°€ ìƒê° ì¤‘...</span>
        </div>

        <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
        <footer class="p-4 bg-slate-900 border-t border-cyan-700/50">
            <form id="chat-form" class="flex space-x-3">
                <input type="text" id="user-input" placeholder="ë©”ì„¸ì§€ê°€ ìƒì„±ì´ ë ë•Œê¹Œì§€ 30ì´ˆê°€ ê±¸ë¦´ìˆ˜ ìˆìŠµë‹ˆë‹¤." 
                       class="flex-grow p-3 rounded-xl bg-slate-800 border border-slate-700 focus:border-indigo-500 focus:ring focus:ring-indigo-500/50 text-white placeholder-slate-500 transition duration-300 outline-none"
                       autocomplete="off" required>
                
                <button type="submit" id="send-button"
                        class="px-5 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl transition duration-300 shadow-lg shadow-indigo-500/30 disabled:bg-slate-600 disabled:shadow-none"
                        disabled>
                    ì „ì†¡
                </button>
            </form>
        </footer>
        
    </div>

    <!-- ì‚¬ìš©ì ë©”ì‹œì§€ ë°•ìŠ¤ (Alert ëŒ€ì²´) -->
    <div id="message-box" class="hidden fixed bottom-5 right-5 z-[9999] p-4 bg-red-600 rounded-lg shadow-2xl items-center space-x-3 transition-all duration-300 transform">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <p id="message-text" class="text-white font-semibold"></p>
    </div>

    <!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ (Confirm ëŒ€ì²´) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 z-[99999] flex items-center justify-center modal-overlay">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-indigo-700">
            <h3 class="text-lg font-bold text-white mb-4">í™•ì¸ í•„ìš”</h3>
            <p id="modal-text" class="text-slate-300 mb-6">ì •ë§ë¡œ ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg transition duration-200">
                    ì·¨ì†Œ
                </button>
                <!-- ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ 'ì‚­ì œ'ë¡œ ë³€ê²½ -->
                <button id="modal-confirm-button" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition duration-200">
                    ì‚­ì œ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // =======================================================================
        // 1. Firebase ë° API ëª¨ë“ˆ ì„í¬íŠ¸
        // =======================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =======================================================================
        // 2. ì„¤ì • ë° DOM ìš”ì†Œ ì •ì˜
        // =======================================================================
        const DALBIT_API_KEY = typeof __api_key !== 'undefined' ? __api_key : "AIzaSyDhoxxpY2nqAdX4XUFmB20ukRlMXa1eLx8"; // API í‚¤ ì„¤ì •
        const API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `${API_BASE_URL}${MODEL_NAME}:generateContent?key=${DALBIT_API_KEY}`;
        
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const newChatButton = document.getElementById('new-chat-button');
        const userIdDisplay = document.getElementById('user-id-display');

        // Firebase ê¸€ë¡œë²Œ ë³€ìˆ˜
        let db, auth, appId, userId;
        let chatCollectionRef;
        let conversationHistory = []; // API í˜ì´ë¡œë“œë¥¼ ìœ„í•œ ëŒ€í™” ê¸°ë¡ ë°°ì—´

        // =======================================================================
        // 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =======================================================================

        /**
         * ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (Alert ëŒ€ì²´)
         */
        function showMessage(message, type = 'error') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');

            // í…Œë§ˆ ì„¤ì •
            messageBox.classList.remove('bg-red-600', 'bg-green-600');
            messageBox.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.classList.remove('flex');
            }, 5000);
        }
        
        /**
         * ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  ì‚¬ìš©ìì˜ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜ (Confirm ëŒ€ì²´)
         */
        function showConfirmModal(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('confirmation-modal');
                document.getElementById('modal-text').textContent = message;
                const confirmBtn = document.getElementById('modal-confirm-button');
                const cancelBtn = document.getElementById('modal-cancel-button');

                modal.classList.remove('hidden');
                
                const handleConfirm = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }


        /**
         * ì±„íŒ… ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         * @param {string} text ë©”ì‹œì§€ ë‚´ìš©
         * @param {string} role 'user' ë˜ëŠ” 'model'
         */
        function appendMessage(text, role, isWelcome = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            
            if (role === 'user') {
                messageBubble.className = 'user-message max-w-xs md:max-w-md p-3 rounded-xl shadow-md text-white';
                messageBubble.textContent = text;
            } else {
                messageBubble.className = isWelcome 
                    ? 'ai-message max-w-xs md:max-w-md p-4 rounded-xl shadow-lg transition duration-300 border-indigo-500' 
                    : 'ai-message max-w-xs md:max-w-md p-4 rounded-xl shadow-lg transition duration-300';
                
                const sender = document.createElement('p');
                sender.className = 'font-semibold text-indigo-300 mb-1';
                sender.textContent = 'ë‹¬ë¹› AI';
                messageBubble.appendChild(sender);

                const content = document.createElement('p');
                content.className = 'text-gray-200 whitespace-pre-wrap';
                // ê°„ë‹¨í•œ Markdown (ë³¼ë“œ, ì´íƒ¤ë¦­, ì¤„ë°”ê¿ˆ)ì„ HTMLë¡œ ë³€í™˜í•˜ì—¬ innerHTML ì‚¬ìš©
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // **ë³¼ë“œ**
                formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>'); // *ì´íƒ¤ë¦­*
                content.innerHTML = formattedText;
                messageBubble.appendChild(content);
            }

            messageWrapper.appendChild(messageBubble);
            chatHistory.appendChild(messageWrapper);
        }

        /**
         * ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
         */
        function appendInitialWelcome() {
             const hasMessages = chatHistory.querySelector('.flex') !== null;
             if (hasMessages) return; // ì´ë¯¸ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ

             appendMessage(
                 "ì•ˆë…•! ë‚˜ëŠ” ë‹¬ë¹› AIì•¼. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë´. ë³µì¡í•œ ì•„ì´ë””ì–´ë¶€í„° ê°„ë‹¨í•œ ì§ˆë¬¸ê¹Œì§€ ë„ì™€ì¤„ ì¤€ë¹„ê°€ ë˜ì–´ ìˆì–´.", 
                 'model', 
                 true
             );
        }

        /**
         * ì…ë ¥ í•„ë“œì˜ ìƒíƒœì— ë”°ë¼ ì „ì†¡ ë²„íŠ¼ì„ í™œì„±í™”/ë¹„í™œì„±í™”
         */
        function toggleButtonState() {
            sendButton.disabled = userInput.value.trim() === '';
        }

        // =======================================================================
        // 4. Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        // =======================================================================

        async function initFirebaseAndAuth() {
            try {
                // 1. Firebase Config ë° App ID ê°€ì ¸ì˜¤ê¸°
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-dalbit-app-id';

                // 2. Firebase ì´ˆê¸°í™”
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 3. ì¸ì¦ ì²˜ë¦¬ (ìº”ë²„ìŠ¤ í™˜ê²½ í† í° ë˜ëŠ” ìµëª… ë¡œê·¸ì¸)
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 4. ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID: ${userId}`;
                        
                        // 5. Firestore ì»¬ë ‰ì…˜ ê²½ë¡œ ì„¤ì • ë° ê¸°ë¡ ë¡œë“œ ì‹œì‘
                        chatCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chat_history`);
                        loadHistory();
                    } else {
                        userIdDisplay.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
                        // ë¹„ë¡œê·¸ì¸ ì‹œì—ë„ ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ëŠ” í‘œì‹œ
                        appendInitialWelcome(); 
                    }
                });

                showMessage("Firebase ì—°ê²° ë° ì‚¬ìš©ì ì¸ì¦ ì„±ê³µ", 'success');
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                showMessage(`Firebase ì˜¤ë¥˜: ${error.message}`, 'error');
                appendInitialWelcome(); // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í™˜ì˜ ë©”ì‹œì§€ëŠ” í‘œì‹œ
            }
        }

        // =======================================================================
        // 5. Firestore ë°ì´í„° ë¡œë“œ ë° ê´€ë¦¬
        // =======================================================================

        /**
         * Firestoreì—ì„œ ëŒ€í™” ê¸°ë¡ì„ ë¡œë“œí•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function loadHistory() {
            if (!chatCollectionRef) return;

            const q = query(chatCollectionRef, orderBy('timestamp', 'asc'));

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(q, (snapshot) => {
                // UI ì´ˆê¸°í™”
                chatHistory.innerHTML = '';
                
                // API í˜ì´ë¡œë“œë¥¼ ìœ„í•œ ëŒ€í™” ê¸°ë¡ ì¬êµ¬ì„±
                conversationHistory = [];
                
                // Firestore ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ UI ë° API ê¸°ë¡ êµ¬ì„±
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    
                    // UIì— ë©”ì‹œì§€ ì¶”ê°€
                    if (data.role && data.text) {
                        appendMessage(data.text, data.role); 
                        
                        // API ê¸°ë¡ì— ì¶”ê°€
                        conversationHistory.push({ role: data.role, parts: [{ text: data.text }] });
                    }
                });
                
                // ë©”ì‹œì§€ê°€ ì—†ë‹¤ë©´ ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
                if (snapshot.empty) {
                    appendInitialWelcome();
                }

                // ìŠ¤í¬ë¡¤ì„ ê°€ì¥ ì•„ë˜ë¡œ ì´ë™
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }, (error) => {
                console.error("Firestore onSnapshot ì˜¤ë¥˜:", error);
                showMessage("ì±„íŒ… ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", 'error');
                appendInitialWelcome();
            });
        }
        
        /**
         * ëŒ€í™” ê¸°ë¡ ì „ì²´ë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
         */
        async function clearHistory() {
            if (!chatCollectionRef) {
                showMessage("ì±„íŒ… ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
                return;
            }
            
            const isConfirmed = await showConfirmModal("ì •ë§ë¡œ ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (!isConfirmed) return;

            try {
                // ì»¬ë ‰ì…˜ì˜ ëª¨ë“  ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                const snapshot = await getDocs(chatCollectionRef);
                
                // ëª¨ë“  ë¬¸ì„œ ì‚­ì œ
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // 'ìƒˆë¡œìš´ ì±„íŒ…ì´ ì‹œì‘ë˜ì—ˆì–´' ëŒ€ì‹  'ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆì–´'ë¡œ ë©”ì‹œì§€ ìˆ˜ì •
                showMessage('ëª¨ë“  ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆì–´.', 'success');
                // onSnapshot ë¦¬ìŠ¤ë„ˆê°€ UIë¥¼ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
            } catch (error) {
                console.error("ê¸°ë¡ ì‚­ì œ ì˜¤ë¥˜:", error);
                showMessage(`ê¸°ë¡ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            }
        }


        // =======================================================================
        // 6. Gemini API í†µì‹  ë¡œì§ (Exponential Backoff í¬í•¨)
        // =======================================================================

        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ (ì§€ìˆ˜ ë°±ì˜¤í”„ í¬í•¨)
         */
        async function fetchGeminiResponse(maxRetries = 5, delay = 1000) {
            // API í˜¸ì¶œ ì§ì „ì— conversationHistoryê°€ ë¹„ì–´ ìˆì§€ ì•ŠìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
            if (conversationHistory.length === 0) {
                 // ì´ ì‹œì ì—ì„œ conversationHistoryê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì•ˆ ë©ë‹ˆë‹¤. 
                 // ì´ ì˜¤ë¥˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë˜ì ¸ ë””ë²„ê¹…ì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.
                 throw new Error("API í˜¸ì¶œ ì‹œ conversationHistoryê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            const payload = {
                contents: conversationHistory,
                // ì‹œìŠ¤í…œ ì§€ì¹¨ì„ ì¶”ê°€í•˜ì—¬ ëª¨ë¸ì˜ í˜ë¥´ì†Œë‚˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                systemInstruction: {
                    // **[ìˆ˜ì •ë¨: ë°˜ë§ ë° ì¥ë¬¸ ë‹µë³€ ìš”ì²­]**
                    parts: [{ text: "ë„ˆëŠ” í•œêµ­ì–´ì— ëŠ¥í†µí•˜ë©°, ê³ ê¸‰ ë°ì´í„° ë¶„ì„ ë° ì°½ì˜ì  ì½˜í…ì¸  ìƒì„±ì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” 'ë‹¬ë¹› AI' ì±—ë´‡ì´ì•¼. ì‚¬ìš©ìì™€ ì¹œêµ¬ì²˜ëŸ¼ í¸í•˜ê³  ê²©ì˜ ì—†ëŠ” ë§íˆ¬(ë°˜ë§)ë¥¼ ì‚¬ìš©í•˜ë©°, ì§ˆë¬¸ì— ëŒ€í•´ í•­ìƒ ë§¤ìš° ìƒì„¸í•˜ê³  ê´‘ë²”ìœ„í•˜ê²Œ ì •ë³´ë¥¼ ì œê³µí•˜ì—¬ ë‹µë³€ì´ ê¸¸ê³  ê¹Šì´ ìˆê²Œ ëŠê»´ì§€ë„ë¡ ì‘ì„±í•´ ì¤˜. ê·¸ë¦¬ê³  ì‚¬ìš©ìê°€ ë³µì¡í•œ ì§ˆë¬¸ì„ í• ë•ŒëŠ” ì„¬ì„¸í•˜ê²Œ ê³„ì‚°í•˜ê±°ë‚˜ ê²€ìƒ‰ì„ í•˜ì—¬ ìµœëŒ€í•œ ë§ì´ ì•Œì•„ë‚´." }]
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // HTTP ì˜¤ë¥˜ ì²˜ë¦¬
                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Rate limit exceeded. Retrying...');
                        } else if (response.status >= 400 && response.status < 500) {
                            const errorData = await response.json();
                            // API ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ì—¬ Client Errorë¥¼ throw í•©ë‹ˆë‹¤.
                            throw new Error(`Client Error: ${response.status} - ${errorData.error.message || 'Unknown client error'}`);
                        } else {
                            throw new Error(`Server Error: ${response.status} - Retrying...`);
                        }
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else if (candidate && candidate.finishReason === 'SAFETY') {
                        return "ë¯¸ì•ˆí•´. ìš”ì²­í•œ ë‚´ìš©ì€ ì•ˆì „ ì •ì±… ë•Œë¬¸ì— ìƒì„±í•  ìˆ˜ ì—†ì–´.";
                    } else {
                        throw new Error('API ì‘ë‹µì—ì„œ ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                } catch (error) {
                    // console.error(`API í˜¸ì¶œ ì‹¤íŒ¨ (ì‹œë„ ${i + 1}/${maxRetries}):`, error.message);
                    
                    if (i < maxRetries - 1 && (error.message.includes('Rate limit') || error.message.includes('Server Error'))) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else if (error.message.includes('Client Error')) {
                        throw error;
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. API ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }

        // =======================================================================
        // 7. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ë©”ì¸ ë¡œì§
        // =======================================================================

        /**
         * ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬ í•¨ìˆ˜
         */
        async function handleSendMessage(e) {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt || !chatCollectionRef) {
                if (!chatCollectionRef) showMessage("ì±„íŒ… ê¸°ë¡ ì €ì¥ì†Œ(Firestore)ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì¤˜.", 'error');
                return;
            }

            // 1. UI ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            userInput.value = '';
            toggleButtonState();
            sendButton.disabled = true; 
            loadingIndicator.classList.remove('hidden');

            // 2. ì‚¬ìš©ì ë©”ì‹œì§€ ê°ì²´ ìƒì„±
            const userMessageData = {
                text: prompt,
                role: 'user',
                timestamp: serverTimestamp()
            };

            // 3. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ Firestoreì— ì €ì¥ (onSnapshotì´ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤)
            const userSavePromise = addDoc(chatCollectionRef, userMessageData);

            // 4. API í˜¸ì¶œì„ ìœ„í•´ conversationHistoryì— ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ ì¶”ê°€ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
            // onSnapshotì´ Firestore ì—…ë°ì´íŠ¸ë¥¼ ë°˜ì˜í•˜ê¸° ì „ì— API í˜¸ì¶œì´ ì´ë£¨ì–´ì§€ëŠ” ë¬¸ì œ ë°©ì§€
            conversationHistory.push({ role: 'user', parts: [{ text: prompt }] });
            
            try {
                // 5. API í˜¸ì¶œ
                const aiResponseText = await fetchGeminiResponse();
                
                // 6. AI ë©”ì‹œì§€ë¥¼ Firestoreì— ì €ì¥
                const aiSavePromise = addDoc(chatCollectionRef, {
                    text: aiResponseText,
                    role: 'model',
                    timestamp: serverTimestamp()
                });

                // Firestore ì €ì¥ ì™„ë£Œ ëŒ€ê¸°
                await userSavePromise;
                await aiSavePromise;
                
            } catch (error) {
                // 7. ì˜¤ë¥˜ ì²˜ë¦¬
                console.error("ìµœì¢… API ì˜¤ë¥˜:", error);
                const errorMessage = `API í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´: ${error.message}. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ë´.`;
                
                // API í˜¸ì¶œ ì‹¤íŒ¨ë¡œ ì¸í•´ conversationHistoryì— ì¶”ê°€ëœ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì œê±° (ì„ íƒì )
                // í•˜ì§€ë§Œ Firestore ê¸°ë¡ì€ ê·¸ëŒ€ë¡œ ë‘ì–´ ì‚¬ìš©ìê°€ ì˜¤ë¥˜ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ Firestoreì— ì €ì¥í•˜ì—¬ ê¸°ë¡í•©ë‹ˆë‹¤.
                addDoc(chatCollectionRef, {
                    text: errorMessage,
                    role: 'model',
                    timestamp: serverTimestamp()
                });
                showMessage(errorMessage, 'error');
            } finally {
                // 8. ìƒíƒœ ë³µêµ¬
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false; // ì „ì†¡ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                toggleButtonState(); // ì…ë ¥ í•„ë“œ ìƒíƒœì— ë”°ë¼ ìµœì¢… ê²°ì •
            }
        }

        // =======================================================================
        // 8. ì´ˆê¸°í™”
        // =======================================================================

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        chatForm.addEventListener('submit', handleSendMessage);
        userInput.addEventListener('input', toggleButtonState);
        newChatButton.addEventListener('click', clearHistory);

        // ì´ˆê¸° ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™” ë° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        window.onload = () => {
             initFirebaseAndAuth();
             toggleButtonState();
        };

    </script>

</body>
</html>
