<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>PeerJS 메신저 (이름 표시)</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body { font-family:sans-serif; background:#111; color:#eee; margin:0; }
    .container { max-width:800px; margin:20px auto; padding:20px; }
    .card { background:#222; padding:16px; border-radius:8px; margin-bottom:16px; }
    input,button { padding:8px; margin:4px; }
    .messages { height:300px; overflow:auto; background:#000; padding:10px; border-radius:8px; }
    .msg { margin:6px 0; }
    .me { text-align:right; color:#4da3ff; }
    .other { text-align:left; color:#7be0b0; }
    .meta { font-size:12px; color:#aaa; }
  </style>
</head>
<body>
<div class="container">

  <!-- 로그인 화면 -->
  <div id="loginCard" class="card">
    <h2>로그인</h2>
    <input id="loginUser" placeholder="아이디"><br>
    <input id="loginPass" type="password" placeholder="비밀번호"><br>
    <button id="loginBtn">로그인</button>
    <p>계정이 없나요? <a href="#" id="toRegister">회원가입</a></p>
    <div id="loginMsg"></div>
  </div>

  <!-- 회원가입 화면 -->
  <div id="registerCard" class="card" style="display:none">
    <h2>회원가입</h2>
    <input id="regUser" placeholder="아이디"><br>
    <input id="regPass" type="password" placeholder="비밀번호"><br>
    <input id="regDisplay" placeholder="표시 이름"><br>
    <button id="registerBtn">가입하기</button>
    <p>이미 계정이 있나요? <a href="#" id="toLogin">로그인</a></p>
    <div id="regMsg"></div>
  </div>

  <!-- 메신저 화면 -->
  <div id="chatCard" class="card" style="display:none">
    <h2>PeerJS 메신저</h2>
    <div>내 ID: <span id="myId">생성중...</span></div>
    <input id="peerIdInput" placeholder="상대 Peer ID">
    <button id="connectBtn">연결</button>
    <div id="status"></div>
    <div class="messages" id="messages"></div>
    <input id="msgInput" placeholder="메시지 입력" disabled>
    <button id="sendBtn" disabled>전송</button>
  </div>

</div>

<script>
  // --- 계정 관리 (LocalStorage) ---
  function getAccounts(){ return JSON.parse(localStorage.getItem("accounts")||"{}"); }
  function saveAccounts(acc){ localStorage.setItem("accounts", JSON.stringify(acc)); }

  // --- 화면 전환 ---
  document.getElementById("toRegister").onclick = ()=>{ 
    loginCard.style.display="none"; registerCard.style.display="block"; 
  };
  document.getElementById("toLogin").onclick = ()=>{ 
    registerCard.style.display="none"; loginCard.style.display="block"; 
  };

  // --- 회원가입 ---
  registerBtn.onclick = ()=>{
    const u=regUser.value.trim(), p=regPass.value.trim(), d=regDisplay.value.trim();
    if(!u||!p){ regMsg.textContent="아이디/비밀번호 입력"; return; }
    const acc=getAccounts();
    if(acc[u]){ regMsg.textContent="이미 존재하는 아이디"; return; }
    acc[u]={pw:p, display:d||u};
    saveAccounts(acc);
    regMsg.textContent="가입 성공! 로그인하세요.";
  };

  // --- 로그인 ---
  let currentUser=null, currentDisplay=null;
  loginBtn.onclick=()=>{
    const u=loginUser.value.trim(), p=loginPass.value.trim();
    const acc=getAccounts();
    if(acc[u] && acc[u].pw===p){
      currentUser=u; currentDisplay=acc[u].display||u;
      loginCard.style.display="none"; chatCard.style.display="block";
      startPeer(u);
    } else { loginMsg.textContent="로그인 실패"; }
  };

  // --- PeerJS ---
  let peer, conn;
  function startPeer(userId){
    peer=new Peer(userId,{config:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]}});
    peer.on("open", id=>{ myId.textContent=id; status.textContent="내 Peer 준비됨"; });
    peer.on("connection", c=>{ conn=c; setupConn(); });
  }
  function setupConn(){
    conn.on("open", ()=>{ status.textContent="상대와 연결됨"; msgInput.disabled=false; sendBtn.disabled=false; });
    conn.on("data", data=>{
      if(data.type==="msg"){ addMsg(data.text,"other",data.from); }
    });
  }
  connectBtn.onclick=()=>{
    conn=peer.connect(peerIdInput.value.trim());
    setupConn();
  };

  // --- 메시지 전송 ---
  sendBtn.onclick=sendMsg;
  msgInput.addEventListener("keydown",e=>{ if(e.key==="Enter") sendMsg(); });
  function sendMsg(){
    const text=msgInput.value;
    if(text && conn && conn.open){
      const packet={type:"msg", from:currentDisplay, text:text};
      conn.send(packet);
      addMsg(text,"me",currentDisplay);
      msgInput.value="";
    }
  }

  // --- 메시지 표시 ---
  function addMsg(text,who,from){
    const div=document.createElement("div");
    div.className="msg "+who;
    div.innerHTML=`<div class="meta">${from}</div><div>${text}</div>`;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;
  }
</script>
</body>
</html>
